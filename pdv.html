<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV - Sistema de Gest√£o de Restaurante</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="manifest" href="/Nexus/manifest.json">
    <meta name="theme-color" content="#1e293b">
    <link rel="apple-touch-icon" href="/Nexus/imagens/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nexus">
    <link rel="icon" type="image/png" href="/Nexus/imagens/favicon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Nexus">
</head>
<body class="bg-gray-100">
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Ponto de Venda (PDV)</h1>
            <a href="/Nexus/dashboard.html" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                Voltar
            </a>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">
        <div id="comandaInfoBox" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-8 hidden" role="alert">
            <p class="font-bold">Pagamento de Comanda:</p>
            <p id="comandaMessage">Comanda #ID Mesa N¬∞ - Total: R$ 0,00</p>
        </div>

        <div class="bg-white rounded-lg shadow-xl p-8">
            <h2 class="text-3xl font-bold text-gray-700 mb-6">Finalizar Venda</h2>
            
            <form id="vendaForm">
                
                <input type="hidden" id="comanda_id_input" name="comanda_id" value="">

                <div class="mb-6 border-b pb-4">
                    <label class="block text-gray-600 mb-2 text-lg">Valor a Receber (Total) *</label>
                    <input 
                        type="number" 
                        step="0.01"
                        id="valorTotal" 
                        placeholder="0.00" 
                        value="0.00"
                        min="0.01"
                        class="w-full px-4 py-3 text-4xl font-extrabold text-blue-700 border border-blue-400 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-200 bg-blue-50"
                        required
                    />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-600 mb-2">M√©todo de Pagamento *</label>
                        <select 
                            id="metodoPagamento" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            required
                        >
                            <option value="dinheiro">Dinheiro</option>
                            <option value="cartao_debito">Cart√£o de D√©bito</option>
                            <option value="cartao_credito">Cart√£o de Cr√©dito</option>
                            <option value="pix">PIX</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-600 mb-2">Valor Pago pelo Cliente</label>
                        <input 
                            type="number" 
                            step="0.01"
                            id="valorPago" 
                            placeholder="0.00" 
                            value="0.00"
                            min="0.00"
                            class="w-full px-4 py-3 text-xl font-semibold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            required
                        />
                    </div>
                </div>
                
                <div class="mt-6 mb-8 p-4 bg-green-100 rounded-lg border-l-4 border-green-500">
                    <p class="text-gray-700">Troco Necess√°rio:</p>
                    <p id="trocoDisplay" class="text-3xl font-extrabold text-green-700">R$ 0,00</p>
                </div>

                <div class="mb-8">
                    <label class="block text-gray-600 mb-2">Observa√ß√µes da Venda (Opcional)</label>
                    <textarea 
                        id="observacoes" 
                        rows="2"
                        placeholder="Ex: Cliente utilizou cupom de desconto, pagamento misto..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                    ></textarea>
                </div>
                
                <button 
                    type="submit" 
                    class="w-full bg-green-600 text-white px-8 py-4 rounded-lg hover:bg-green-700 transition text-2xl font-bold shadow-lg"
                >
                    <span id="botaoTexto">Registrar Venda</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://nexus-backend-pvj4.onrender.com';
        let comandaIdParaVenda = null; 

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            comandaIdParaVenda = urlParams.get('comanda_id');

            // 1. Verificar se √© um pagamento de comanda
            if (comandaIdParaVenda) {
                carregarComandaParaPDV(comandaIdParaVenda);
                document.getElementById('botaoTexto').textContent = 'Registrar Pagamento da Comanda';
            } else {
                console.log('PDV iniciado em modo de Venda Direta.');
                // L√≥gica de PDV normal (vendas diretas)
            }
            
            // 2. Adicionar listeners para c√°lculo de troco e submiss√£o do formul√°rio
            document.getElementById('valorTotal').addEventListener('input', calcularTroco);
            document.getElementById('valorPago').addEventListener('input', calcularTroco);
            document.getElementById('vendaForm').addEventListener('submit', registrarVenda);

            // Inicializar o c√°lculo do troco
            calcularTroco();
        });

        // =========================================================================
        // FUN√á√ÉO DE CARREGAMENTO DA COMANDA
        // =========================================================================
        async function carregarComandaParaPDV(id) {
            try {
                const response = await fetch(`${API_URL}/api/comandas/${id}`);
                
                if (!response.ok) {
                    throw new Error('Comanda n√£o encontrada ou erro ao carregar.');
                }
                
                const comanda = await response.json();

                // 1. Preencher o campo de Total da Venda
                const valorTotalInput = document.getElementById('valorTotal');
                valorTotalInput.value = comanda.total.toFixed(2);
                valorTotalInput.readOnly = true; // Impede a altera√ß√£o do valor da comanda

                // 2. Preencher o campo Valor Pago para facilitar
                document.getElementById('valorPago').value = comanda.total.toFixed(2);

                // 3. Adicionar o ID da comanda ao campo oculto
                document.getElementById('comanda_id_input').value = id;
                
                // 4. Mostrar o box de informa√ß√£o
                const infoBox = document.getElementById('comandaInfoBox');
                infoBox.classList.remove('hidden');
                document.getElementById('comandaMessage').textContent = 
                    `Comanda #${comanda.id} da Mesa ${comanda.mesa_numero} carregada. Total: R$ ${comanda.total.toFixed(2)}.`;
                
                // Recalcular troco
                calcularTroco();

            } catch (error) {
                console.error('Erro ao carregar comanda para PDV:', error);
                alert('Erro ao carregar a comanda. Iniciando PDV em modo de Venda Direta.');
                comandaIdParaVenda = null;
                document.getElementById('valorTotal').readOnly = false;
                document.getElementById('comandaInfoBox').classList.add('hidden');
            }
        }

        // =========================================================================
        // FUN√á√ÉO DE C√ÅLCULO DE TROCO
        // =========================================================================
        function calcularTroco() {
            const total = parseFloat(document.getElementById('valorTotal').value) || 0;
            const pago = parseFloat(document.getElementById('valorPago').value) || 0;
            
            const troco = pago - total;
            const trocoDisplay = document.getElementById('trocoDisplay');

            if (troco < 0) {
                // Cliente ainda deve
                trocoDisplay.textContent = `Faltam R$ ${Math.abs(troco).toFixed(2)}`;
                trocoDisplay.classList.remove('text-green-700', 'text-red-500');
                trocoDisplay.classList.add('text-red-600');
            } else {
                // Troco para o cliente
                trocoDisplay.textContent = `R$ ${troco.toFixed(2)}`;
                trocoDisplay.classList.remove('text-red-600');
                trocoDisplay.classList.add('text-green-700');
            }
        }

        // =========================================================================
        // FUN√á√ÉO DE REGISTRO DA VENDA (Pagamento)
        // =========================================================================
        async function registrarVenda(e) {
            e.preventDefault();

            const total = parseFloat(document.getElementById('valorTotal').value);
            const pago = parseFloat(document.getElementById('valorPago').value);

            if (pago < total) {
                alert('O valor pago √© insuficiente para cobrir o valor total!');
                return;
            }

            const data = {
                valor_total: total,
                valor_pago: pago,
                troco: pago - total,
                metodo_pagamento: document.getElementById('metodoPagamento').value,
                observacoes: document.getElementById('observacoes').value,
                // Envia o ID da comanda APENAS se estiver presente
                comanda_id: comandaIdParaVenda ? parseInt(comandaIdParaVenda) : null 
            };

            const confirmacaoMsg = comandaIdParaVenda 
                ? `Confirmar pagamento da Comanda #${comandaIdParaVenda} de R$ ${data.valor_total.toFixed(2)}?`
                : `Confirmar Venda Direta de R$ ${data.valor_total.toFixed(2)}?`;
                
            if (!confirm(confirmacaoMsg)) {
                return;
            }

            try {
                // Endpoint para registrar vendas/pagamentos
                const response = await fetch(`${API_URL}/api/vendas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Venda/Pagamento registrado com sucesso!');
                    
                    // Se for pagamento de comanda, volta para a tela de mesas
                    if (comandaIdParaVenda) {
                        window.location.href = '/Nexus/mesas.html';
                    } else {
                        // Se for venda direta, reseta o formul√°rio
                        document.getElementById('vendaForm').reset();
                        document.getElementById('valorTotal').value = '0.00';
                        document.getElementById('valorPago').value = '0.00';
                        calcularTroco();
                    }
                } else {
                    const error = await response.json();
                    alert(`Erro ao registrar venda: ${error.error}`);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor para registrar a venda.');
            }
        }
        
    </script>
    
    <button 
      id="install-button" 
      style="display: none; position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; background: #1e293b; color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; font-weight: 600;"
    >
      üì± Instalar App
    </button>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/Nexus/service-worker.js')
            .then(registration => {
              console.log('‚úÖ Service Worker registrado com sucesso:', registration.scope);
            })
            .catch(error => {
              console.error('‚ùå Erro ao registrar Service Worker:', error);
            });
        });
      }

      // Bot√£o de instala√ß√£o PWA
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (event) => {
        event.preventDefault();
        deferredPrompt = event;
        const installButton = document.getElementById('install-button');
        if (installButton) {
          installButton.style.display = 'block';
          installButton.addEventListener('click', () => {
            installButton.style.display = 'none';
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
              if (choiceResult.outcome === 'accepted') {
                console.log('‚úÖ App instalado');
              }
              deferredPrompt = null;
            });
          });
        }
      });
    </script>
</body>
</html>