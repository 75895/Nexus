<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insumos - Sistema de Gest√£o de Restaurante</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="manifest" href="/Nexus/manifest.json">
    <meta name="theme-color" content="#1e293b">
    <link rel="apple-touch-icon" href="/Nexus/imagens/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nexus">
    <link rel="icon" type="image/png" href="/Nexus/imagens/favicon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Nexus">
</head>
<body class="bg-gray-100">
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Gest√£o de Insumos</h1>
            <a href="/Nexus/dashboard.html" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                Voltar ao Dashboard
            </a>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Cadastrar Novo Insumo</h2>
            <form id="insumoForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-gray-600 mb-2">Nome do Insumo</label>
                    <input 
                        type="text" 
                        id="nome" 
                        placeholder="Ex: Farinha de Trigo" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    />
                </div>
                <div>
                    <label class="block text-gray-600 mb-2">Unidade de Medida</label>
                    <input 
                        type="text" 
                        id="unidade_medida" 
                        placeholder="Ex: kg, un, litro" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    />
                </div>
                <div>
                    <label class="block text-gray-600 mb-2">Estoque Inicial</label>
                    <input 
                        type="number" 
                        id="estoque_atual" 
                        placeholder="Ex: 50" 
                        step="0.01"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    />
                </div>
                <div class="md:col-span-3">
                    <button 
                        type="submit" 
                        class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition"
                    >
                        Cadastrar Insumo
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Lista de Insumos</h2>

            <div class="mb-4 flex justify-between items-center">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="üîç Buscar insumo pelo nome..." 
                    class="w-full md:w-1/3 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
            </div>

            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700">
                            <th class="px-4 py-2 text-left">ID</th>
                            <th class="px-4 py-2 text-left">Nome</th>
                            <th class="px-4 py-2 text-left">Unidade</th>
                            <th class="px-4 py-2 text-left">Estoque Atual</th>
                            <th class="px-4 py-2 text-left">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="insumosTableBody">
                        <tr class="text-center"><td colspan="5" class="py-4 text-gray-500">Carregando insumos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="editModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
      <div class="bg-white p-6 rounded-lg shadow-lg w-96">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Editar Insumo</h2>

        <input type="hidden" id="editId" />

        <div class="mb-3">
          <label class="block text-gray-600 mb-1">Nome</label>
          <input id="editNome" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" />
        </div>

        <div class="mb-3">
          <label class="block text-gray-600 mb-1">Unidade de Medida</label>
          <input id="editUnidade" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" />
        </div>

        <div class="mb-3">
          <label class="block text-gray-600 mb-1">Estoque Atual</label>
          <input id="editEstoque" type="number" step="0.01" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" />
        </div>

        <div class="flex justify-end space-x-3">
          <button onclick="fecharModalEdicao()" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">Cancelar</button>
          <button onclick="salvarEdicao()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Salvar</button>
        </div>
      </div>
    </div>

    <script>
        // CORRE√á√ÉO CR√çTICA 1: Adiciona o prefixo /api na URL base.
        // O endpoint de insumos est√° em /api/insumos, ent√£o adicionamos /api aqui
        const API_URL = 'https://nexus-backend-pvj4.onrender.com/api'; 
        let cachedInsumos = []; // Armazena insumos em cache para a fun√ß√£o editarInsumo

        // ===================================
        // FUN√á√ïES CRUD
        // ===================================

        // Carregar lista de insumos
        async function carregarInsumos() {
            const tbody = document.getElementById('insumosTableBody');
            tbody.innerHTML = '<tr class="text-center"><td colspan="5" class="py-4 text-gray-500">Carregando insumos...</td></tr>';
            try {
                // Rota Corrigida: Usando a vari√°vel API_URL que j√° inclui /api
                const response = await fetch(`${API_URL}/insumos`);
                
                if (!response.ok) {
                    throw new Error(`Erro de rede: ${response.statusText}`);
                }
                
                const insumos = await response.json();
                cachedInsumos = insumos; // Cache dos dados

                tbody.innerHTML = ''; // Limpa o "Carregando"
                
                if (insumos.length === 0) {
                    tbody.innerHTML = '<tr class="text-center"><td colspan="5" class="py-4 text-gray-500">Nenhum insumo cadastrado.</td></tr>';
                    return;
                }

                insumos.forEach(insumo => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="px-4 py-2">${insumo.id}</td>
                        <td class="px-4 py-2">${insumo.nome}</td>
                        <td class="px-4 py-2">${insumo.unidade_medida}</td>
                        <td class="px-4 py-2">${insumo.estoque_atual}</td>
                        <td class="px-4 py-2 flex space-x-2">
                            <button onclick="editarInsumo(${insumo.id})" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 transition">
                                Editar
                            </button>
                            <button onclick="excluirInsumo(${insumo.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition">
                                Excluir
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Erro ao carregar insumos:', error);
                tbody.innerHTML = `<tr class="text-center"><td colspan="5" class="py-4 text-red-500">‚ùå Erro ao carregar insumos: ${error.message}</td></tr>`;
            }
        }

        // Cadastrar novo insumo
        document.getElementById('insumoForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const data = {
                nome: document.getElementById('nome').value,
                unidade_medida: document.getElementById('unidade_medida').value,
                estoque_atual: parseFloat(document.getElementById('estoque_atual').value)
            };

            try {
                // Rota Corrigida: Usando a vari√°vel API_URL que j√° inclui /api
                const response = await fetch(`${API_URL}/insumos`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('‚úÖ Insumo cadastrado com sucesso!');
                    document.getElementById('insumoForm').reset();
                    carregarInsumos();
                } else {
                    const errorData = await response.json();
                    alert(`‚ùå Erro ao cadastrar insumo: ${errorData.error || 'Detalhes desconhecidos.'}`);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ö†Ô∏è Erro ao conectar com o servidor.');
            }
        });
        
        // Excluir insumo
        async function excluirInsumo(id) {
            if (!confirm('Tem certeza que deseja excluir este insumo?')) return;

            try {
                // Rota Corrigida: Usando a vari√°vel API_URL que j√° inclui /api
                const response = await fetch(`${API_URL}/insumos/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    carregarInsumos();
                } else {
                    alert('Erro ao excluir insumo: ' + (result.error || 'Detalhes desconhecidos.'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ö†Ô∏è Erro ao conectar com o servidor.');
            }
        }

        // ===================================
        // FUN√á√ïES DE EDI√á√ÉO E FILTRO
        // ===================================

        // Abre o modal de edi√ß√£o e preenche os campos
        function abrirModalEdicao(insumo) {
            const modal = document.getElementById('editModal');
            document.getElementById('editId').value = insumo.id;
            document.getElementById('editNome').value = insumo.nome;
            document.getElementById('editUnidade').value = insumo.unidade_medida;
            document.getElementById('editEstoque').value = insumo.estoque_atual;
            modal.classList.remove('hidden');
        }

        // Fecha o modal de edi√ß√£o
        function fecharModalEdicao() {
            document.getElementById('editModal').classList.add('hidden');
        }

        // Busca o insumo no cache e abre o modal
        function editarInsumo(id) {
            // Usa o cache local para evitar uma nova requisi√ß√£o GET desnecess√°ria
            const insumoToEdit = cachedInsumos.find(i => i.id === id);

            if (!insumoToEdit) {
                alert('Insumo n√£o encontrado no cache. Tentando recarregar...');
                carregarInsumos(); // Recarrega a lista
                return;
            }
            abrirModalEdicao(insumoToEdit);
        }

        // Salvar altera√ß√µes no modal
        async function salvarEdicao() {
            const id = document.getElementById('editId').value;
            const data = {
                nome: document.getElementById('editNome').value,
                unidade_medida: document.getElementById('editUnidade').value,
                estoque_atual: parseFloat(document.getElementById('editEstoque').value)
            };

            try {
                // Rota Corrigida: Usando a vari√°vel API_URL que j√° inclui /api
                const response = await fetch(`${API_URL}/insumos/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('‚úÖ Insumo atualizado com sucesso!');
                    fecharModalEdicao();
                    carregarInsumos();
                } else {
                    const errorData = await response.json();
                    alert(`‚ùå Erro ao atualizar insumo: ${errorData.error || 'Detalhes desconhecidos.'}`);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ö†Ô∏è Erro ao conectar com o servidor.');
            }
        }

        // Filtro de busca em tempo real
        document.getElementById('searchInput').addEventListener('input', function() {
            const termo = this.value.toLowerCase();
            const linhas = document.querySelectorAll('#insumosTableBody tr');

            linhas.forEach(linha => {
                // A linha de carregamento/erro n√£o tem 5 filhos (c√©lulas)
                if (linha.children.length > 1) { 
                    const nome = linha.children[1].textContent.toLowerCase();
                    linha.style.display = nome.includes(termo) ? '' : 'none';
                }
            });
        });

        // ===================================
        // INICIALIZA√á√ÉO
        // ===================================
        document.addEventListener('DOMContentLoaded', carregarInsumos);
        
        // PWA (Mantido como estava)
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/Nexus/service-worker.js')
              .then(registration => {
                console.log('‚úÖ Service Worker registrado com sucesso:', registration.scope);
              })
              .catch(error => {
                console.error('‚ùå Erro ao registrar Service Worker:', error);
              });
          });
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (event) => {
          event.preventDefault();
          deferredPrompt = event;
          const installButton = document.getElementById('install-button');
          if (installButton) {
            installButton.style.display = 'block';
            installButton.addEventListener('click', () => {
              installButton.style.display = 'none';
              deferredPrompt.prompt();
              deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                  console.log('‚úÖ App instalado');
                }
                deferredPrompt = null;
              });
            });
          }
        });
    </script>

    <button 
      id="install-button" 
      style="display: none; position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; background: #1e293b; color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; font-weight: 600;"
    >
      üì± Instalar App
    </button>
</body>
</html>